server {
  listen 8080;
  server_name nguyenlehuy-vivobook-asuslaptop-x512fa-a512fa.tail86e288.ts.net;

  # Devenir MERN app - WITH BUFFERING ENABLED (Better for general API/Load speed)
  location /devenir/ {
    client_max_body_size 50M;           
    proxy_pass http://127.0.0.1:3111/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    # Buffering ON for better performance on slow connections (Tailscale funnel)
    proxy_buffering on;
    proxy_request_buffering on; 

    # Timeout
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_connect_timeout 75s;
  }
  
  # Socket.IO support (Realtime needs buffering OFF)
  location /socket.io/ {
    proxy_pass http://127.0.0.1:3111/socket.io/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    proxy_buffering off;
    proxy_read_timeout 86400;
  }

  # n8n (Needs buffering OFF)
  location /n8n/ {
    proxy_pass http://127.0.0.1:5678/;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_buffering off;
    proxy_cache off;
    chunked_transfer_encoding off;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_connect_timeout 75s;
  }

  # EngPro API
  location /engpro/ {
    proxy_pass http://127.0.0.1:5003/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
  }

  # Root location
  location / {
    return 200 "Server is running!\n\nAccess:\n- Devenir: /devenir/\n- n8n: /n8n/\n- EngPro: /engpro/\n";
    add_header Content-Type text/plain;
  }
}

# Redirect HTTP to HTTPS
server {
  listen 80;
  server_name nguyenlehuy-vivobook-asuslaptop-x512fa-a512fa.tail86e288.ts.net;
  return 301 https://$host$request_uri;
}
